<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RunStrava Pro</title>
    <style>
        :root {
            --primary: #fc4c02;
            --dark: #242428;
            --light: #ffffff;
            --gray: #f0f0f0;
            --text-gray: #6d6d6d;
        }

        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--gray);
            color: var(--dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        header {
            background: var(--light);
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        /* --- Main Content Area --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px; 
        }

        /* --- Cards --- */
        .card {
            background: var(--light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        /* --- Activity Feed --- */
        .activity {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        .activity:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: var(--dark);
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .activity-meta h3 {
            font-size: 0.95rem;
        }
        
        .activity-meta span {
            font-size: 0.75rem;
            color: var(--text-gray);
        }

        .run-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .run-stat div {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .run-stat label {
            font-size: 0.75rem;
            color: var(--text-gray);
            display: block;
        }

        /* --- Tracker UI --- */
        #tracker-view {
            display: none;
            text-align: center;
            height: 100%;
            justify-content: center;
            flex-direction: column;
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 200;
            font-variant-numeric: tabular-nums;
            margin: 20px 0;
        }

        .gps-status {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 10px;
        }

        .tracker-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 40px;
        }

        .circle-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .circle-btn:active { transform: scale(0.95); }
        .btn-start { background: var(--primary); }
        .btn-stop { background: var(--dark); }
        .btn-resume { background: #4CAF50; }
        .btn-finish { background: #E91E63; }

        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        /* --- Modal --- */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(252, 76, 2, 0.4);
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button.full-width {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- Navigation --- */
        nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--light);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #ddd;
        }

        .nav-item {
            text-align: center;
            color: var(--text-gray);
            font-size: 0.7rem;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 2px;
        }

    </style>
</head>
<body>

    <header>
        <h1>RunStrava Pro</h1>
    </header>

    <main id="home-view">
        <div class="card">
            <h2 style="font-size: 0.9rem; margin-bottom: 10px; color: var(--text-gray);">THIS WEEK</h2>
            <div class="stat-grid">
                <div>
                    <div class="stat-value" id="weekly-km">0.0</div>
                    <div class="stat-label">km</div>
                </div>
                <div>
                    <div class="stat-value" id="weekly-time">0h 0m</div>
                    <div class="stat-label">time</div>
                </div>
                <div>
                    <div class="stat-value" id="weekly-runs">0</div>
                    <div class="stat-label">runs</div>
                </div>
            </div>
        </div>

        <h3 style="margin: 20px 0 10px; font-size: 1rem;">Recent Activity</h3>
        <div id="feed-container" class="card">
            <p style="text-align:center; color:#999; padding:20px;">No runs recorded yet.</p>
        </div>
    </main>

    <div id="tracker-view">
        <h2 style="color:var(--text-gray); font-weight:normal;">RECORDING</h2>
        <div class="gps-status" id="gps-status">Waiting for GPS...</div>
        
        <div class="timer-display" id="timer">00:00:00</div>
        
        <div class="tracker-stats">
            <div>
                <div class="stat-value" id="live-dist">0.00</div>
                <div class="stat-label">Kilometers</div>
            </div>
            <div>
                <div class="stat-value" id="live-pace">0:00</div>
                <div class="stat-label">Avg Pace</div>
            </div>
        </div>

        <div class="controls">
            <button id="start-btn" class="circle-btn btn-start" onclick="startRun()">START</button>
            <button id="stop-btn" class="circle-btn btn-stop" onclick="pauseRun()" style="display:none;">STOP</button>
            <button id="finish-btn" class="circle-btn btn-finish" onclick="finishRun()" style="display:none;">FINISH</button>
            <button id="resume-btn" class="circle-btn btn-resume" onclick="resumeRun()" style="display:none;">RESUME</button>
        </div>
    </div>

    <div class="fab" id="fab-add" onclick="openModal()">+</div>

    <div id="entry-modal" class="modal">
        <div class="modal-content">
            <h3>Manual Entry</h3>
            <label>Distance (km)</label>
            <input type="number" id="manual-dist" step="0.01">
            <label>Time (minutes)</label>
            <input type="number" id="manual-time">
            <label>Title</label>
            <input type="text" id="manual-title" placeholder="Morning Run">
            <button class="full-width" onclick="saveManualRun()">Save Run</button>
            <button class="full-width" onclick="closeModal()" style="background:#ddd; color:#333; margin-top:10px;">Cancel</button>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="switchTab('home')">
            <span class="nav-icon">üè†</span>
            Home
        </div>
        <div class="nav-item" onclick="switchTab('record')">
            <span class="nav-icon">‚óâ</span>
            Record
        </div>
        <div class="nav-item" onclick="alert('Profile Coming Soon')">
            <span class="nav-icon">üë§</span>
            You
        </div>
    </nav>

    <script>
        // --- State ---
        let runs = JSON.parse(localStorage.getItem('strava_runs')) || [];
        
        // Tracking Variables
        let timerInterval;
        let seconds = 0;
        let isRunning = false;
        let totalDistance = 0; // in km
        let watchId = null;
        let lastLat = null;
        let lastLon = null;

        // --- Init ---
        window.onload = function() {
            renderFeed();
            updateWeeklyStats();
        };

        // --- Navigation ---
        function switchTab(tab) {
            const homeView = document.getElementById('home-view');
            const trackView = document.getElementById('tracker-view');
            const fab = document.getElementById('fab-add');
            const navItems = document.querySelectorAll('.nav-item');

            if (tab === 'home') {
                homeView.style.display = 'block';
                trackView.style.display = 'none';
                fab.style.display = 'flex';
                navItems[0].classList.add('active');
                navItems[1].classList.remove('active');
            } else if (tab === 'record') {
                homeView.style.display = 'none';
                trackView.style.display = 'flex'; 
                fab.style.display = 'none';
                navItems[0].classList.remove('active');
                navItems[1].classList.add('active');
            }
        }

        // --- GPS Logic ---
        function startRun() {
            if (!("geolocation" in navigator)) {
                alert("Geolocation is not supported by this browser.");
                return;
            }

            // Start Timer
            isRunning = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            document.getElementById('gps-status').innerText = "Acquiring GPS Signal...";
            
            timerInterval = setInterval(() => {
                seconds++;
                updateTrackerUI();
            }, 1000);

            // Start GPS Watch
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    document.getElementById('gps-status').innerText = `GPS Active (Accuracy: ${Math.round(accuracy)}m)`;

                    if (lastLat !== null) {
                        const dist = calculateDistance(lastLat, lastLon, lat, lon);
                        // Only add distance if movement is significant (filter noise > 2 meters)
                        if (dist > 0.002) { 
                            totalDistance += dist;
                        }
                    }
                    
                    lastLat = lat;
                    lastLon = lon;
                    updateTrackerUI();
                },
                (error) => {
                    document.getElementById('gps-status').innerText = "GPS Error: " + error.message;
                },
                options
            );
        }

        function pauseRun() {
            isRunning = false;
            clearInterval(timerInterval);
            navigator.geolocation.clearWatch(watchId); // Stop GPS to save battery
            document.getElementById('gps-status').innerText = "Paused";
            
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('finish-btn').style.display = 'block';
            document.getElementById('resume-btn').style.display = 'block';
        }

        function resumeRun() {
            document.getElementById('finish-btn').style.display = 'none';
            document.getElementById('resume-btn').style.display = 'none';
            startRun(); // Re-bind GPS and timer
        }

        function finishRun() {
            const run = {
                id: Date.now(),
                title: getTimeBasedGreeting() + " Run",
                date: new Date().toISOString(),
                distance: totalDistance, 
                time: seconds / 60, // minutes
                pace: totalDistance > 0 ? (seconds / 60) / totalDistance : 0
            };

            saveRun(run);
            resetTracker();
            switchTab('home');
        }

        // Haversine Formula (Calculate distance between two lat/lon points)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }

        function updateTrackerUI() {
            // Time
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            document.getElementById('timer').innerText = 
                `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            // Distance
            document.getElementById('live-dist').innerText = totalDistance.toFixed(2);

            // Pace (min/km)
            if (totalDistance > 0.05) { // Only calculate pace after 50m to avoid infinity spikes
                const paceDecimal = (seconds / 60) / totalDistance;
                const paceMin = Math.floor(paceDecimal);
                const paceSec = Math.floor((paceDecimal - paceMin) * 60);
                document.getElementById('live-pace').innerText = `${paceMin}:${paceSec.toString().padStart(2, '0')}`;
            } else {
                document.getElementById('live-pace').innerText = "--:--";
            }
        }

        function resetTracker() {
            seconds = 0;
            totalDistance = 0;
            lastLat = null;
            lastLon = null;
            isRunning = false;
            clearInterval(timerInterval);
            navigator.geolocation.clearWatch(watchId);
            
            updateTrackerUI();
            document.getElementById('gps-status').innerText = "Waiting for GPS...";
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
            document.getElementById('finish-btn').style.display = 'none';
            document.getElementById('resume-btn').style.display = 'none';
        }

        function getTimeBasedGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Morning";
            if (hour < 18) return "Afternoon";
            return "Evening";
        }

        // --- Data Handling ---
        function saveManualRun() {
            const dist = parseFloat(document.getElementById('manual-dist').value);
            const time = parseFloat(document.getElementById('manual-time').value);
            const title = document.getElementById('manual-title').value || "Run";

            if (!dist || !time) return alert("Please fill in distance and time");

            const run = {
                id: Date.now(),
                title: title,
                date: new Date().toISOString(),
                distance: dist,
                time: time,
                pace: time / dist
            };

            saveRun(run);
            closeModal();
            document.getElementById('manual-dist').value = '';
            document.getElementById('manual-time').value = '';
        }

        function saveRun(run) {
            runs.unshift(run);
            localStorage.setItem('strava_runs', JSON.stringify(runs));
            renderFeed();
            updateWeeklyStats();
        }

        function renderFeed() {
            const container = document.getElementById('feed-container');
            container.innerHTML = '';

            if (runs.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No runs yet. Go for a run!</p>';
                return;
            }

            runs.forEach(run => {
                const date = new Date(run.date);
                const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
                
                const paceMin = Math.floor(run.pace);
                const paceSec = Math.floor((run.pace - paceMin) * 60);

                const runHrs = Math.floor(run.time / 60);
                const runMins = Math.floor(run.time % 60);
                const timeStr = runHrs > 0 ? `${runHrs}h ${runMins}m` : `${runMins}m`;

                const html = `
                <div class="activity">
                    <div class="user-header">
                        <div class="avatar">Y</div>
                        <div class="activity-meta">
                            <h3>You</h3>
                            <span>${dateStr}</span>
                        </div>
                    </div>
                    <h2 style="font-size:1.1rem; margin-bottom:5px;">${run.title}</h2>
                    <div class="run-stats">
                        <div class="run-stat">
                            <label>Distance</label>
                            ${run.distance.toFixed(2)} km
                        </div>
                        <div class="run-stat">
                            <label>Pace</label>
                            ${paceMin}:${paceSec.toString().padStart(2, '0')} /km
                        </div>
                        <div class="run-stat">
                            <label>Time</label>
                            ${timeStr}
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        function updateWeeklyStats() {
            let totalDist = 0;
            let totalTime = 0;
            runs.forEach(run => {
                totalDist += run.distance;
                totalTime += run.time;
            });

            document.getElementById('weekly-km').innerText = totalDist.toFixed(1);
            document.getElementById('weekly-runs').innerText = runs.length;
            
            const hrs = Math.floor(totalTime / 60);
            const mins = Math.floor(totalTime % 60);
            document.getElementById('weekly-time').innerText = `${hrs}h ${mins}m`;
        }

        function openModal() { document.getElementById('entry-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('entry-modal').style.display = 'none'; }

    </script>
</body>
</html>